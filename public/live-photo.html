<!DOCTYPE html>
<html>

<head>

  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
</head>

<body onload="openACampra()"  >

 
  
  <video style="object-fit: cover;" width="320" height="240"  id="videoId" playsinline autoplay></video>
  <img  id="imageId" />
  <br />

  <!-- <button id="takeNew" onclick="openACampra()">Take New</button> -->

  <button onclick="captureAImage()" id="buttonId">Capture</button>

</body>

</html>

<script>

  'use strict';
  // Put variables in global scope to make them available to the browser console.

    fetch('/SLRetailer/diy/activation/checkSession', {
      method: 'get', // or 'PUT'
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({}),
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success:', data);
    })
    .catch((error) => {
      console.error('Error:', error);
    });

  function captureAImage() {
    const video = document.querySelector('#videoId');
    const canvas = document.createElement('canvas');


    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);


    //var img = new Image();
    var img = document.getElementById('imageId');
    img.src = canvas.toDataURL();
    img.height = 240; 
    img.width = 320;
    img.type = "image/png"; 

    console.log("img: ", img);

    
    // var blobBin = atob(img.src.split(',')[1]);
   
    // console.log(" img.src.split(',')[1]",  img.src.split(',')[0]);

    // var array = [];
    // for (var i = 0; i < blobBin.length; i++) {
    //   array.push(blobBin.charCodeAt(i));
    // }
    // var file = new Blob([new Uint8Array(array)], { type: 'image/png' });
    // // console.log("file", file);

    // canvas.toBlob(blob => {
    //   const file = new File([blob], "image.png");
    //   console.log("file", file);
    // });


      function srcToFile(src, fileName, mimeType){
          return (fetch(src)
              .then(function(res){return res.arrayBuffer();})
              .then(function(buf){return new File([buf], fileName, {type:mimeType});})
          );
      }

      //usage example: (works in Chrome and Firefox)
      //convert src to File and upload to server php
      srcToFile(img.src, 'new.png', 'image/png')
      .then(function(file){
          console.log("promisefile", file.toString());

      })
      .catch(console.error);


    
    document.getElementById('videoId').style.display = 'none';
    stopStreamedVideo();

     const buttonId = document.querySelector('#buttonId');
     buttonId.style.display = "none";

  };


  function openACampra() {
    console.log("camara open")

    // const buttonId = document.querySelector('#buttonId');
    // buttonId.innerHTML = "Take a Selfie"; 
    // buttonId.addEventListener("click", captureAImage);


    const video = document.querySelector('#videoId');
    document.getElementById('videoId').style.display = 'block';
    document.getElementById('imageId').src = "";

    function handleSuccess(stream) {
      window.stream = stream; // make stream available to browser console
      video.srcObject = stream;
    }

    function handleError(error) {
      console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
    }

    const constraints = {
      audio: false,
      video: true
    };

    navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);
    console.log("navigator", navigator);

    var img = document.getElementById('imageId');
    img.height = 0; 
    img.width = 0; 



  }
  function stopStreamedVideo() {
  const videoElem = document.querySelector('#videoId');
  const stream = videoElem.srcObject;
  const tracks = stream.getTracks();

  tracks.forEach(function(track) {
    track.stop();
  });

  videoElem.srcObject = null;
}

init();


</script>

<script>
  // function init() { 
  
  //       var  iframe = document.getElementById("camraIframeId");
  //       var iWindow = iframe && iframe.contentWindow;
  //       var iDocument = iWindow && iWindow.document;
  //       var selfie = iDocument && iDocument.images[0]; 
  //       if(!selfie){
  //           window.location.reload('/'); 
  //       }
  
  // }
//  function yourMethod(arg) { ... }
  </script>

</body>

</html>